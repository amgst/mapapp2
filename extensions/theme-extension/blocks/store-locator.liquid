{% comment %}
  Store Locator App Block
  This block displays an interactive map with store locations
{% endcomment %}

<div class="store-locator-block" id="store-locator-{{ block.id }}">
  <div class="store-locator-header">
    {% if block.settings.title != blank %}
      <h2 class="store-locator-title">{{ block.settings.title }}</h2>
    {% endif %}
    {% if block.settings.description != blank %}
      <p class="store-locator-description">{{ block.settings.description }}</p>
    {% endif %}
  </div>

  <div class="store-locator-content">
    {% if block.settings.show_search %}
      <div class="store-search">
        <input type="text" id="store-search-{{ block.id }}" placeholder="{{ block.settings.search_placeholder | default: 'Enter your location...' }}" class="store-search-input">
        <button type="button" class="store-search-btn" onclick="searchStores('{{ block.id }}')">{{ block.settings.search_button_text | default: 'Find Stores' }}</button>
      </div>
    {% endif %}

    <div class="map-container" id="map-container-{{ block.id }}">
      <div id="map-{{ block.id }}" class="interactive-map" style="height: {{ block.settings.map_height }}px;"></div>
    </div>

    {% if block.settings.show_store_list %}
      <div class="store-list" id="store-list-{{ block.id }}">
        <h3>{{ block.settings.store_list_title | default: 'Store Locations' }}</h3>
        <div class="store-items" id="store-items-{{ block.id }}"></div>
      </div>
    {% endif %}
  </div>
</div>

<script>
  // Store locator functionality
  window.storeLocatorData = window.storeLocatorData || {};
  window.storeLocatorData['{{ block.id }}'] = {
    apiKey: '{{ block.settings.google_maps_api_key }}',
    defaultLat: {{ block.settings.default_latitude | default: 40.7128 }},
    defaultLng: {{ block.settings.default_longitude | default: -74.0060 }},
    zoom: {{ block.settings.default_zoom | default: 10 }},
    stores: [
      {% for store in block.settings.store_locations %}
        {
          name: '{{ store.name | escape }}',
          address: '{{ store.address | escape }}',
          lat: {{ store.latitude }},
          lng: {{ store.longitude }},
          phone: '{{ store.phone | escape }}',
          hours: '{{ store.hours | escape }}'
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  };

  function initStoreLocator(blockId) {
    const data = window.storeLocatorData[blockId];
    if (!data || !data.apiKey) return;

    // Initialize Google Maps
    const map = new google.maps.Map(document.getElementById(`map-${blockId}`), {
      center: { lat: data.defaultLat, lng: data.defaultLng },
      zoom: data.zoom
    });

    // Add store markers
    data.stores.forEach(store => {
      const marker = new google.maps.Marker({
        position: { lat: store.lat, lng: store.lng },
        map: map,
        title: store.name
      });

      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div class="store-info">
            <h4>${store.name}</h4>
            <p>${store.address}</p>
            ${store.phone ? `<p>Phone: ${store.phone}</p>` : ''}
            ${store.hours ? `<p>Hours: ${store.hours}</p>` : ''}
          </div>
        `
      });

      marker.addListener('click', () => {
        infoWindow.open(map, marker);
      });
    });

    // Update store list
    updateStoreList(blockId, data.stores);
  }

  function updateStoreList(blockId, stores) {
    const storeList = document.getElementById(`store-items-${blockId}`);
    if (!storeList) return;

    storeList.innerHTML = stores.map(store => `
      <div class="store-item">
        <h4>${store.name}</h4>
        <p>${store.address}</p>
        ${store.phone ? `<p>Phone: ${store.phone}</p>` : ''}
        ${store.hours ? `<p>Hours: ${store.hours}</p>` : ''}
      </div>
    `).join('');
  }

  function searchStores(blockId) {
    const searchInput = document.getElementById(`store-search-${blockId}`);
    const query = searchInput.value.toLowerCase();
    const data = window.storeLocatorData[blockId];
    
    if (!query) {
      updateStoreList(blockId, data.stores);
      return;
    }

    const filteredStores = data.stores.filter(store => 
      store.name.toLowerCase().includes(query) || 
      store.address.toLowerCase().includes(query)
    );
    
    updateStoreList(blockId, filteredStores);
  }

  // Initialize when Google Maps API is loaded
  function initializeStoreLocator{{ block.id | replace: '-', '' }}() {
    initStoreLocator('{{ block.id }}');
  }

  // Load Google Maps API if not already loaded
  if (typeof google === 'undefined' && '{{ block.settings.google_maps_api_key }}' !== '') {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key={{ block.settings.google_maps_api_key }}&callback=initializeStoreLocator{{ block.id | replace: '-', '' }}`;
    script.async = true;
    document.head.appendChild(script);
  } else if (typeof google !== 'undefined') {
    initStoreLocator('{{ block.id }}');
  }
</script>

<style>
  .store-locator-block {
    margin: 2rem 0;
    padding: 1rem;
  }

  .store-locator-title {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: {{ block.settings.title_color | default: '#333' }};
  }

  .store-locator-description {
    margin-bottom: 1.5rem;
    color: {{ block.settings.text_color | default: '#666' }};
  }

  .store-search {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .store-search-input {
    flex: 1;
    min-width: 200px;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
  }

  .store-search-btn {
    padding: 0.75rem 1.5rem;
    background-color: {{ block.settings.button_color | default: '#007cba' }};
    color: {{ block.settings.button_text_color | default: '#fff' }};
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
  }

  .store-search-btn:hover {
    opacity: 0.9;
  }

  .map-container {
    margin-bottom: 2rem;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .interactive-map {
    width: 100%;
  }

  .store-list {
    background: #f9f9f9;
    padding: 1.5rem;
    border-radius: 8px;
  }

  .store-list h3 {
    margin-bottom: 1rem;
    color: {{ block.settings.title_color | default: '#333' }};
  }

  .store-item {
    background: white;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .store-item:last-child {
    margin-bottom: 0;
  }

  .store-item h4 {
    margin-bottom: 0.5rem;
    color: {{ block.settings.title_color | default: '#333' }};
  }

  .store-item p {
    margin-bottom: 0.25rem;
    color: {{ block.settings.text_color | default: '#666' }};
  }

  .store-info {
    max-width: 250px;
  }

  .store-info h4 {
    margin-bottom: 0.5rem;
  }

  .store-info p {
    margin-bottom: 0.25rem;
  }

  @media (max-width: 768px) {
    .store-search {
      flex-direction: column;
    }
    
    .store-search-input {
      min-width: 100%;
    }
  }
</style>

{% schema %}
{
  "name": "Store Locator",
  "target": "section",
  "stylesheet": "store-locator.css",
  "javascript": "store-locator.js",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Find Our Stores"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Locate our stores near you"
    },
    {
      "type": "text",
      "id": "google_maps_api_key",
      "label": "Google Maps API Key",
      "info": "Required for map functionality"
    },
    {
      "type": "range",
      "id": "map_height",
      "label": "Map Height (px)",
      "min": 200,
      "max": 800,
      "step": 50,
      "default": 400
    },
    {
      "type": "text",
      "id": "default_latitude",
      "label": "Default Latitude",
      "default": "40.7128"
    },
    {
      "type": "text",
      "id": "default_longitude",
      "label": "Default Longitude",
      "default": "-74.0060"
    },
    {
      "type": "range",
      "id": "default_zoom",
      "label": "Default Zoom Level",
      "min": 1,
      "max": 20,
      "step": 1,
      "default": 10
    },
    {
      "type": "checkbox",
      "id": "show_search",
      "label": "Show Search Bar",
      "default": true
    },
    {
      "type": "text",
      "id": "search_placeholder",
      "label": "Search Placeholder Text",
      "default": "Enter your location..."
    },
    {
      "type": "text",
      "id": "search_button_text",
      "label": "Search Button Text",
      "default": "Find Stores"
    },
    {
      "type": "checkbox",
      "id": "show_store_list",
      "label": "Show Store List",
      "default": true
    },
    {
      "type": "text",
      "id": "store_list_title",
      "label": "Store List Title",
      "default": "Store Locations"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title Color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Background Color",
      "default": "#007cba"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    }
  ]
}
{% endschema %}
{% comment %}
  Custom Map Builder App Block
  This block displays the React-based custom map builder for personalized products
{% endcomment %}

<div class="map-builder-block" id="map-builder-{{ block.id }}">
  <div class="map-builder-header">
    {% if block.settings.title != blank %}
      <h2 class="map-builder-title">{{ block.settings.title }}</h2>
    {% endif %}
    {% if block.settings.description != blank %}
      <p class="map-builder-description">{{ block.settings.description }}</p>
    {% endif %}
  </div>

  <div class="map-builder-content">
    <!-- React App Container -->
    <div id="map-builder-root-{{ block.id }}" class="map-builder-app" style="min-height: {{ block.settings.app_height }}px;">
      <div class="loading-placeholder">
        <div class="loading-spinner"></div>
        <p>Loading Custom Map Builder...</p>
      </div>
    </div>
  </div>
</div>

<script>
  // React Map Builder Integration - Isolated Scope
  (function(window, document, undefined) {
    'use strict';
    
    // Prevent conflicts with existing Shopify theme scripts
    const originalDetailsDisclosure = window.DetailsDisclosure;
    const originalDetailsModal = window.DetailsModal;
    const originalSearchForm = window.SearchForm;
    
    // Create isolated scope for our app
    const config = {
       theme: '{{ block.settings.theme }}',
       defaultProduct: '{{ block.settings.default_product }}',
       checkoutEnabled: {{ block.settings.checkout_enabled }},
       primaryColor: '{{ block.settings.primary_color }}',
       secondaryColor: '{{ block.settings.secondary_color }}'
     };

    // Set global configuration for React app
    window.SHOPIFY_MAP_CONFIG = config;
    
    // Apply theme configuration
    document.documentElement.style.setProperty('--shopify-primary', config.primaryColor);
    document.documentElement.style.setProperty('--shopify-secondary', config.secondaryColor);
    
    if (config.theme === 'dark') {
      document.body.classList.add('dark');
    }

    // Dispatch custom event when map builder is ready
    window.dispatchEvent(new CustomEvent('shopify-map-ready'));
    
    // Initialize React app container
    const container = document.getElementById('map-builder-root-{{ block.id }}');
    if (container) {
      // Create iframe to load React app
      const iframe = document.createElement('iframe');
      iframe.src = '{{ block.settings.app_url | default: "http://localhost:5173" }}/builder?shopDomain={{ shop.permanent_domain }}&blockId={{ block.id }}';
      iframe.style.width = '100%';
      iframe.style.height = '{{ block.settings.app_height | default: 800 }}px';
      iframe.style.border = 'none';
      iframe.style.borderRadius = '8px';
      iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-popups');
      iframe.setAttribute('loading', 'lazy');
      iframe.onload = function() {
        // Hide loading placeholder
        const placeholder = container.querySelector('.loading-placeholder');
        if (placeholder) placeholder.style.display = 'none';
      };

      // Replace loading placeholder with iframe
      container.appendChild(iframe);
    }

    // Handle cart integration
    window.addToShopifyCart = function(product) {
      console.log('Adding to cart:', product);
      
      // Integrate with Shopify's cart API
      const formData = new FormData();
      formData.append('id', product.id);
      formData.append('quantity', 1);
      
      if (product.customization) {
        formData.append('properties[Map Customization]', JSON.stringify(product.customization));
      }
      
      fetch('/cart/add.js', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        console.log('Added to cart:', data);
        // Trigger cart drawer or redirect
        if (window.theme && window.theme.cartDrawer) {
          window.theme.cartDrawer.open();
        } else {
          window.location.href = '/cart';
        }
      })
      .catch(error => {
        console.error('Error adding to cart:', error);
      });
    };

    // Handle messages from React app
    window.addEventListener('message', function(event) {
      const allowedOrigins = ['{{ block.settings.app_url | default: "http://localhost:5173" }}', 'http://localhost:5173', 'https://localhost:5173'];
      if (!allowedOrigins.includes(event.origin)) return;
      
      const { type, data } = event.data;
      
      switch (type) {
        case 'ADD_TO_CART':
          window.addToShopifyCart(data);
          break;
        case 'RESIZE_APP':
          // Handle app resize requests
          const iframe = document.querySelector(`#map-builder-root-{{ block.id }} iframe`);
          if (iframe && data.height) {
            iframe.style.height = data.height + 'px';
          }
          break;
      }
    });

    // Initialize map builder when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        // App initialization is handled above
      });
    }
    
    // Restore original classes if they existed to prevent conflicts
    if (originalDetailsDisclosure && !window.DetailsDisclosure) {
      window.DetailsDisclosure = originalDetailsDisclosure;
    }
    if (originalDetailsModal && !window.DetailsModal) {
      window.DetailsModal = originalDetailsModal;
    }
    if (originalSearchForm && !window.SearchForm) {
      window.SearchForm = originalSearchForm;
    }
    
  })(window, document);
</script>

<style>
  .map-builder-block {
    margin: 2rem 0;
    padding: 1rem;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  }

  .map-builder-title {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: {{ block.settings.title_color | default: '#333' }};
    text-align: center;
  }

  .map-builder-description {
    margin-bottom: 1.5rem;
    color: {{ block.settings.text_color | default: '#666' }};
    text-align: center;
    font-size: 1.1rem;
  }

  .map-builder-content {
    position: relative;
  }

  .map-builder-app {
    width: 100%;
    border-radius: 8px;
    overflow: hidden;
    background: #f8f9fa;
    position: relative;
  }

  .loading-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: center;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .loading-placeholder p {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 500;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .map-builder-block {
      margin: 1rem 0;
      padding: 0.5rem;
    }
    
    .map-builder-title {
      font-size: 1.5rem;
    }
    
    .loading-placeholder {
      padding: 2rem 1rem;
    }
  }

  /* Dark theme support */
  @media (prefers-color-scheme: dark) {
    .map-builder-block {
      background: #1a1a1a;
      color: #fff;
    }
    
    .map-builder-app {
      background: #2a2a2a;
    }
  }
</style>

{% schema %}
{
  "name": "Custom Map Builder",
  "target": "section",
  "javascript": "map-builder-loader.js",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Create Your Custom Map"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Design personalized maps for cutting boards, ornaments, and candles"
    },
    {
      "type": "text",
      "id": "app_url",
      "label": "Map Builder App URL",
      "default": "https://your-domain.com",
      "info": "URL where the React map builder app is hosted"
    },
    {
      "type": "range",
      "id": "app_height",
      "label": "App Height (px)",
      "min": 400,
      "max": 1200,
      "step": 50,
      "default": 800
    },
    {
      "type": "select",
      "id": "theme",
      "label": "Theme",
      "options": [
        {
          "value": "light",
          "label": "Light"
        },
        {
          "value": "dark",
          "label": "Dark"
        }
      ],
      "default": "light"
    },
    {
      "type": "product",
      "id": "default_product",
      "label": "Default Product",
      "info": "Select the default product to show in the map builder"
    },
    {
      "type": "checkbox",
      "id": "enable_checkout",
      "label": "Enable Direct Checkout",
      "default": true,
      "info": "Allow customers to add customized products directly to cart"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title Color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#666666"
    }
  ]
}
{% endschema %}